# 気象データ取得・特徴量化 仕様書

## 背景
空き家リスクの説明・予測に使う気候指標（年平均気温・平均積雪量）を、市区町村単位の代表値として作成する。  
従来の30年平年値ではなく、直近数年（例：2018–2023）の平均を用いて、温暖化や積雪変動を反映させる。

---

## スコープ（本仕様①）
- メッシュ: KSJ G02（2022, 1kmベクターポリゴン）
- 対象変数: 年平均気温, 年平均最低気温, 年平均最高気温(近似), 年最深積雪, 年降水量
- 代表値: 面積重み平均（Area-Weighted Mean）
- 期間: 2022年データ（将来 2018–2023平均へ拡張可）
- 出力: `data/processed/climate_city__v1.csv`

> 将来拡張②（メモ）：AMeDAS実測＋DEMを用いた回帰＋残差補間で1km格子を再推定し、市区町村平均を再作成

---

## 入出力

### 入力

- **気象メッシュ(2022)**: `data/raw/climate/G02-22_*jgd.geojson`
  - 出典: 国土数値情報 G02（気象メッシュ）
  - CRS: EPSG:4612（ファイル内CRS定義あり）
- **市区町村境界**: `data/geojson/municipalities.geojson`
  - 生成: `scripts/ref/011_build_municipalities_geojson_from_osm.py`
  - 必須列: `市区町村コード`(5桁), `市区町村名`, `都道府県コード`, `都道府県名`, `geometry`
  - CRS: EPSG:4326（ETL側で投影）
- **設定YAML**
  - `config/etl_project.yaml`: `study_regions.*.prefecture_codes` で対象都道府県を指定可能
  - `config/ref_project.yaml`: 境界生成時の列名エイリアスを参照

### 出力
- CSV: `data/processed/climate_city__v1.csv`
市区町村コード,最高気温, 最低気温, 平均気温, 年最深積雪,年降水量
---

## 処理フロー
1. CRS統一: 両データを `EPSG:32654`（UTM 54N）へ投影
2. オーバーレイ: 市区町村ポリゴン × 気象メッシュを `intersection`
3. 交差面積と重み: `w = area(intersection) / area(municipality)`
4. 欠損処理: KSJの欠損コード（`999999`, `99999`, `9999`）は NA として除外
5. 変数別再正規化: 非欠損セルのみで `w` を再正規化（Σw_var = 1.0 相当）
6. 集計: 変数ごとに面積重み平均を算出
7. 丸め・出力: CSVへ書き出し（詳細は出力仕様）

実装: `scripts/etl/130_climate_city_from_ksj_g02_2022.py`

---

## 品質確認
- 重み合計: 変数ごとに非欠損セルで再正規化（Σw_var ≈ 1.0）
- 欠損伝播防止: 欠損コードは事前に NA 化、平均・最大の計算から除外
- 地理的一貫性: 高標高地域で気温が低い、豪雪域で積雪が高い 等
- 異常値検出: `年最深積雪 > 10000` や `年降水量 > 10000` が無いことを確認

---

## 将来拡張（メモ）
- AMeDAS実測（2018–2023）から観測点ごとに平均を算出
- DEM（標高）を説明変数にした回帰＋残差補間
- 1kmグリッドを再構築して同じ集計器に流す
- 山岳地域（八ヶ岳など）の精度向上に有効


---
## 標高補正を加味した気候推定（改善施策）
	•	山地では観測所が少なく、1kmメッシュも標高差を十分反映できない場合がある。
	•	将来的には以下を導入することで精度向上を図る:
	1.	AMeDAS実測値（2018–2023）の年平均気温・積雪データを取得
	2.	標高（DEM: 数値標高モデル）を説明変数に追加
	3.	回帰式「気温 ≈ β0 + β1×標高」を構築し、残差をIDW補間
	4.	市区町村ポリゴンに集計して特徴量化
	•	特に八ヶ岳山麓地域のように標高差が大きい場合、この補正は住みやすさ推定の信頼性向上につながる。

⸻

---

## 変数マッピング（KSJ G02 2022）
- 年降水量: `G02_014`（単位 0.1mm）
  - 欠損時は月別 `G02_002..013` の合計/10 で補完
- 年平均気温: 月別平均 `G02_027..038` の平均（単位 0.1°C → /10）
- 年平均最低気温: 月別平均最低 `G02_039..050` の平均（0.1°C → /10）
- 年平均最高気温(近似): `2 × 年平均気温 − 年平均最低気温`
  - 正式な年最高系列が判明したら差し替え
- 年最深積雪: 月別最深 `G02_054..058`（冬季）から各メッシュで最大値（cm）

## 単位・丸め
- 平均気温/最低気温/最高気温: °C, 小数2桁
- 年降水量: mm, 小数1桁
- 年最深積雪: cm, 整数（nullable Int64）

## 出力仕様
- パス: `data/processed/climate_city__v1.csv`
- 列: `市区町村コード, 最高気温, 最低気温, 平均気温, 年最深積雪, 年降水量`
- 対象: `--pref-codes` により都道府県絞り込み可（未指定は全域）

## 実行例
- 境界生成（キャッシュのみ使用）:
  - `PYTHONPATH=. python scripts/ref/011_build_municipalities_geojson_from_osm.py --config config/etl_project.yaml --region yatsugatake_alps --no-network`
- 気象ETL（八ヶ岳〜中部アルプス）:
  - `python scripts/etl/130_climate_city_from_ksj_g02_2022.py --pref-codes 19 20 21 22`
  - `python scripts/etl/130_climate_city_from_ksj_g02_2022.py --region yatsugatake_alps`

## 既知の注意点
- 境界: 政令市の親コードは除外（区レベル/有効な自治体のみ）
- 欠損コード: `999999` 等が多いメッシュは変数ごとにカバレッジが低下し、NA になる場合がある
- 最高気温: 現状は近似。正式系列に差し替え予定
- パフォーマンス: 全国集計は重いため、都道府県コードでの絞り込みを推奨
