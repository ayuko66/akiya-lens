# 特徴量テーブル（features_master）ETL 仕様 v1

## 目的
空き家リスク分析・可視化のための学習用特徴量テーブルを作成する。結合条件や欠損の扱いを明確化し、再現可能な形で `data/processed/features_master__wide__v1.csv` を生成する。

## 出力
- パス: `data/processed/features_master__wide__v1.csv`
- キー: `市区町村コード`（5桁, 先頭ゼロ許容）。名称は参照マスタから補完。
- 行集合: 2023 住宅・土地統計（FEH）の市区町村（全国・都道府県等の集計行は除外）。`study_regions.*.prefecture_codes`（例: 19,20,21,22）で地域フィルタ。

## ベース集合（行の決定）
- 入力: `data/raw/FEH_00200522_2023_2508.csv`
- 抽出: `全国、都道府県、市区町村 コード` が5桁かつ末尾`000`以外（全国・都道府県・「市全域」等の集計行を除外）
- 地域: `config/etl_project.yaml` の `study_regions` 指定に従って都道府県コードで絞り込み
- `市区町村名`: 参照マスタから補完（無ければ元CSVの名称）

## 主な結合（すべて市区町村コードで結合）
結合キーは原則 `市区町村コード` のみ。名称の微妙な差異（例: 「南巨摩郡富士川町」vs「富士川町」）で結合が落ちないようにする。

- 参照マスタ: `data/master/city_master__all__v1_preview.csv`
  - 列: `都道府県コード`, `都道府県名`, `過疎地域市町村`, `都市種別`
- 人口（2018/2023）: `data/processed/population_stats__v1__…csv`
  - 処理: 2018/2023のみ抽出しワイド化（接頭辞 `2018_`, `2023_`）
  - 指標: `総人口`,`15歳未満人口`,`15〜64歳人口`,`65歳以上人口`,`出生/死亡/転入/転出`と各種率
  - 注意: 世帯系（`世帯数`/`1世帯当たり人員`）は出力しない
  - 厳密合計: `15〜64歳人口` 等は必要ビンのどれかが欠損なら値は欠損（NA）
- OSM POI密度: `data/processed/osm_density_with_pt_clinic.csv`
  - 列: 駅/学校/病院/スーパーの件数と面積当たり密度（`…密度[件/km²]`）
- 地価: `data/processed/132_landprice_residential_median__wide__v1.csv`
  - 列: `住宅地価_中央値_2018/2023`, `住宅地価_log中央値_2018/2023`, `標準地点数_2018/2023`, `住宅地価_log差分`, `住宅地価_増減率[%]`
- 気象: `data/processed/climate_city__v1.csv`
  - 列: `最高気温`,`最低気温`,`平均気温`,`年最深積雪`,`年降水量`
- 空き家（2018/2023）: `data/processed/housing_vacancy__wide__v1_*.csv`
  - 列: `住宅総数_2018/2023`, `空き家_2018/2023`, `空き家率_2018/2023`, `空き家_増加率_5年_%`, `空き家率_差分_5年_pt`
  - 2018欠損の市区町村は 2018列がNAのまま出力（2023だけあっても行は残す）
  - 2023不足の補完: 原票 `FEH_00200522_2023_2508.csv` から `総数/空き家` を数値化・集計して 2023列を補完（`…_2023_raw`→欠損補完）

## 派生列の計算
- 2023年総人口あたりの密度（4列）
  - `2023年総人口あたりの駅密度` = `駅件数` / `2023_総人口`
  - `2023年総人口あたりの学校密度` = `学校件数` / `2023_総人口`
  - `2023年総人口あたりの病院密度` = `病院件数` / `2023_総人口`
  - `2023年総人口あたりのスーパー密度` = `スーパー件数` / `2023_総人口`
  - 分母が0/欠損なら結果は欠損（NA）

## 欠損の扱い
- 人口の年齢区分（15〜64など）: 必要ビンのどれか欠損→合計は欠損
- 空き家2018が無い: 2018列は欠損、差分/増加率は欠損
- 2023空き家系は processed 欠損時に raw で補完（可能な範囲）

## 実行
- 依存: pandas
- コマンド:
```bash
python3 scripts/etl/200_features_master.py
```

## 関連仕様
- 空き家ETL: `docs/空き家データETL仕様.md`
  - マスタ結合はコードのみ。2018/2023いずれか一方のみでも行は出力。
- OSM POI密度: `docs/OSM_POI密度ETL仕様.md`
- 気象: `docs/気象データETL仕様.md`

## 既知の注意点
- 行政界改編（例: 区再編等）により、2018と2023でコードが非対称な自治体は 2018 側が欠損になる
- 地価のピボットは `市区町村コード, 市区町村名` をインデックスにしているが、内部集計であり結合ではない
- 将来、2018側の空き家原票からの補完を追加する余地あり

