# Akiya‑Lens 残差モデル仕様 & Streamlitアプリ設計（v1）

> リポジトリ: `https://github.com/ayuko66/akiya-lens` 想定ランタイム: Python 3.10+ / Streamlit 最終更新: 2025-09-27 (JST)

---

## 0. 目的と全体像

- **目的**: 2018→2023 の空き家率の動きをベースラインで吸収し、残差に表れる“その他要因”をモデル化し、自治体単位で **要因（SHAP）×状況（2023空き家率）×増勢（Δ）** を地図で直感的に示す。
- **提供価値**:
  - 政策対話: 「どこが今も高く、どこが増えつつあるか」「何が効いてそうか」を同一画面で説明可能。
  - 解釈性: ベースライン（2018空き家率）を拘束条件にし、**残差モデル**で他要因の寄与を抽出。
  - 運用容易性: 単一CSV（`features_master__wide__v1.csv`）と学習済み`.cbm`で再現可能。

---

## 1. データ仕様（I/Oコントラクト）

### 1.1 入力データ

- `data/processed/features_master__wide__v1.csv`

  - 必須列（最低限）
    - `市区町村コード`（キー）
    - `市区町村名_2023`
    - `空き家率_2018`, `空き家率_2023`
  - 特徴量（例 / 現仕様の抜粋）
    - 人口動態: `2018_出生率[‰]`, `2018_年少人口率[%]`, `2018_死亡率[‰]`, `2018_生産年齢人口率[%]`, `2018_転入超過率[‰]`, `2018_高齢化率[%]`, `2023_出生率[‰]`,`2023_年少人口率[%]`, `2023_死亡率[‰]`, `2023_生産年齢人口率[%]`, `2023_転入超過率[‰]`, `2023_高齢化率[%]`,

    - OSM密度: `駅密度[件/km²]`, `スーパー密度[件/km²]`, `学校密度[件/km²]`, `病院密度[件/km²]`

    - 人口あたり密度: `2023年総人口あたりの駅密度` , `2023年総人口あたりの学校密度`, `2023年総人口あたりのスーパー密度`,

    - 地価: `住宅地価_log中央値_2018`, `住宅地価_log中央値_2023`

    - 気象: `平均気温`, `年最深積雪`, `年降水量`, `最低気温`

    - 地域区分: `過疎地域市町村`（one-hot化前の元列）

- `data/processed/geojson/municipalities.geojson`

  - `properties.市区町村コード` を持つ市区町村ポリゴン集合

### 1.2 出力/成果物

- 学習済みモデル: `models/catboost_residual_model.cbm`
- モデル学習ログ: `catboost_info/`（CVログ, 学習/評価エラー, tfevents 等）
- モデル指標: `data/processed/model_metrics.json`（R², RMSE, CV設定）
- SHAP要約: `data/processed/catboost_mean_abs_shap.csv`（任意; 解釈用）

---

## 2. ベースライン & 残差モデル仕様

### 2.1 ベースライン（回帰）

- モデル式:  \(y_{23} = \alpha + \beta \cdot y_{18} + \varepsilon\)
  - \(y_{18}\): 2018年空き家率
  - \(y_{23}\): 2023年空き家率
  - 推定法: OLS（`sklearn.linear_model.LinearRegression`）
- 出力:
  - `baseline_pred = \hat{\alpha} + \hat{\beta} · 空き家率_2018`
  - `residual = 空き家率_2023 − baseline_pred`
  - `R²_base` をログに保存（説明力の基準値）

> **オプション（将来対応）**: **重み付きベースライン** 標本サイズ差によるヘテロスケ対策として、二項近似 \(Var(p)≈p(1−p)/N\) を用い、 \(Var(Δp) ≈ p_{23}(1−p_{23})/N_{23} + p_{18}(1−p_{18})/N_{18}\) の逆数を重みとする。

### 2.2 残差モデル（CatBoost）

- 目的変数: `residual`
- 説明変数: 上記特徴量群（**ただし** `空き家率_2018`, `空き家率_2023` は投入しない）
- 前処理:
  - `過疎地域市町村` を one-hot化 → `過疎地域市町村_A/B/C` 等
  - 数値欠損はCatBoost内部の処理に委譲（必要なら単純代入 + 欠損フラグで強化）
- ハイパーパラメータ（現行）
  - `iterations=1000, learning_rate=0.05, depth=6, loss_function="RMSE", eval_metric="R2", random_seed=42`
- 検証: 5-fold CV（`shuffle=True, partition_random_seed=42`）
  - 記録: `test-RMSE-mean`, `test-R2-mean` の最終行を指標として採用
- 学習/保存:
  - 全データ再学習 → `models/catboost_residual_model.cbm`
  - SHAP計算（`TreeExplainer`）→ 平均絶対寄与を CSV 保存（任意）

### 2.3 推論時の合成予測

- `pred_residual = residual_model.predict(X_total)`
- `pred_2023 = 空き家率_2018 + pred_residual`
- `residual_infer = 空き家率_2023 − pred_2023`（評価表示用; 実運用では unknown）

---

## 3. リスクレベル定義（4段階）

- 記号
  - `Δ = 空き家率_2023 − 空き家率_2018`
  - 現況しきい値: `P75 = percentile(空き家率_2023, 75)`
  - 横ばい許容帯: `|Δ| ≤ tol`（既定 `tol=0.1` %pt; データ特性で0.2–0.3に調整可）
- ルール
  1. `high_now = (空き家率_2023 ≥ P75)`
  2. `trend = "増" if Δ>tol else "減" if Δ<−tol else "横ばい"`
  3. ラベル
     - **赤(最優先)**: `high_now & trend=="増"`
     - **オレンジ(注意)**: `high_now & trend in {横ばい, 減}`
     - **黄(警戒)**: `¬high_now & trend=="増"`
     - **緑(低)**: `¬high_now & trend in {横ばい, 減}`
- カラーマップ
  - 赤 `#d73027`, 橙 `#fc8d59`, 黄 `#fee08b`, 緑 `#1a9850`

---

## 4. Streamlit アプリ仕様

### 4.1 画面構成

- **サイドバー**
  - 地図の色分け: `4段階リスク / 実測空き家率(2023) / 予測空き家率(2023) / 残差(実測−予測)`
  - （将来）自治体検索、指標フィルタ（例: 人口規模, 地域区分）
- **メイン**
  - 地図（`folium + streamlit-folium`）
  - クリックポップアップ（ツールチップ）
  - （下段）データテーブル / ミニチャート（任意）

### 4.2 ツールチップ/ポップアップ内容

- 表示フィールド
  - `自治体名 = 市区町村名_2023`
  - `空き家率(2018)`, `空き家率(2023)`, `Δ(23−18)`
  - `4段階リスク`
  - `SHAP Top3（残差要因）`: `特徴名: +0.123 / ...`（絶対値Top3）
- 生成ロジック（SHAP Top3）
  - `TreeExplainer(model).shap_values(X)` の行ベクトルから `abs` 降順で上位3項目を抽出
  - 計算コスト対策: 初回のみ計算・キャッシュ（`@st.cache_data`）

### 4.3 地図ロジック

- GeoJoin: `municipalities.geojson`(properties.`市区町村コード`) ↔ `features_master`(`市区町村コード`)
- スタイル
  - **4段階**: `style_function` でカテゴリ色塗り + カスタム凡例（Jinja2/HTML）
  - **連続値**: `folium.Choropleth`（`YlOrRd`）
- 初期ビュー: `center=[35.6, 137.8], zoom=6, tiles="cartodbpositron"`

### 4.4 計算列（アプリ起動時に生成）

- `baseline_pred`, `pred_residual`, `pred_2023`, `delta`, `risk`, `shap_top3`, `map_value`

### 4.5 依存関係（最小）

```
streamlit
pandas
numpy
geopandas
folium
streamlit-folium
catboost
shap
jinja2
```

### 4.6 パフォーマンス/安定化

- `@st.cache_data`/`@st.cache_resource` でデータ・モデル・SHAPをキャッシュ
- 大容量GeoJSONのときは事前に**簡略化**（`topojson`化 or `simplify`）
- 欠損は明示色（`nan_fill_color`=lightgray）

### 4.7 エラーハンドリング

- GeoJoin未一致（型不一致/ゼロ埋め） → ログ & カウント表示
- モデル/CSVの不在 → 明示ダイアログとガイド（配置先パスを提示）

---

## 5. 学習パイプライン（再現手順）

1. CSV読込 → 必須列チェック → 欠損行の扱いをログ出力
2. ベースライン OLS 学習・評価（`R²_base`）→ `baseline_pred/residual` 生成
3. 残差モデル（CatBoost）5-fold CV → `R²_resid, RMSE_resid` を `model_metrics.json` に保存
4. 全データ再学習 → `models/catboost_residual_model.cbm` 保存
5. SHAP（全行）計算 → TopK要因（平均絶対寄与）CSV保存（任意）
6. `catboost_info/` に学習ログ保存（既存ディレクトリ構成に準拠）

---

## 6. ディレクトリ構成（抜粋と役割）

- `app.py` … 本体（Streamlit）
- `models/catboost_residual_model.cbm` … 学習済み残差モデル
- `data/processed/features_master__wide__v1.csv` … 入力特徴量
- `data/processed/geojson/municipalities.geojson` … 市区町村ポリゴン
- `data/processed/model_metrics.json` … 学習指標
- `data/processed/catboost_mean_abs_shap.csv` … SHAP要約（任意）
- `catboost_info/` … CatBoost学習ログ（CV, 学習曲線ほか）
- `docs/` … ETL仕様群 + **本ドキュメント**

---

## 7. 品質保証（QA）/ 受け入れ基準（Acceptance Criteria）

- [機能] 地図クリックで **自治体名/空き家率(2018/2023)/Δ/4段階リスク/SHAP Top3** が表示される
- [視覚] 4段階リスクの色が要求どおり（赤/橙/黄/緑）で凡例がある
- [再現] `models/*.cbm` と `features_master__wide__v1.csv` のみで予測値が再現できる
- [性能] 初回描画 < 5s（ローカルM1/M2想定, GeoJSON簡略化済）
- [健全性] `model_metrics.json` に CV R²/RMSE が記録されている
- [解釈] SHAP Top3 に空要素や NaN が出ない（計算失敗時は明示）

---

## 8. 既知の制約 / リスク

- ベースラインに 2018年空き家率の説明力が高いため、**残差の分散が小さい地域**では SHAPの安定性が下がりうる
- OSM・財務などの**欠測**が集中する地域でバイアス（`OSM_missing`等の欠損フラグ導入で緩和可）
- 市町村合併/境界変更の影響（2018↔2023でコードの継続性を確認）

---

## 9. 今後の拡張（Backlog）

- **重み付き学習**: Δの分散推定に基づくサンプル重み（上限クリップ付き）
- **ペアワイズ相互作用**: EBM/SHAP interaction 値の定点観測
- **政策レコメンド**: SHAPパターンに応じた施策テンプレの自動提示
- **指標の追加**: 空き家発生ポテンシャル（立地適正化計画, 公共交通アクセス, ハザード）
- **デプロイ**: Streamlit Community Cloud / Docker（`main.py`エントリ）
- **自動テスト**: I/Oスキーマ検証（`pandera`） & 地図Join一致率のCIチェック

---

## 10. 付録

### 10.1 主要擬似コード

```python
# ベースライン
lr.fit(y18.reshape(-1,1), y23)
baseline_pred = lr.predict(y18.reshape(-1,1))
residual = y23 - baseline_pred

# 残差モデル
residual_model.fit(X_total, residual)
pred_residual = residual_model.predict(X_total)
pred_2023 = y18 + pred_residual

# リスク
P75 = np.nanpercentile(y23, 75)
trend = np.where(delta>tol, '増', np.where(delta<-tol, '減', '横ばい'))
high_now = y23 >= P75
# マッピングは仕様セクションの通り
```

### 10.2 アプリ起動チェックリスト

-

---

**メンテ方針**: 初版は Issue にも同内容を作成し、以降の修正は `docs/` を正とし、Issue から参照する（変更履歴はPRで管理）。

