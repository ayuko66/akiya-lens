# 空き家データ ETL 仕様書
（2018/2023）

## 対象データ
- **総務省統計局 e-Stat** 住宅・土地統計調査（調査番号: 00200522）
- 表: 「居住世帯の有無別 住宅数 ― 市区町村」
- 対象年: **2018年, 2023年**
- CSVは手動ダウンロード（API利用も可）

---

## 入力
- `data/raw/FEH_00200522_2018_2508.csv`  
- `data/raw/FEH_00200522_2023_2508.csv`  
- 市区町村マスタ: `data/master/city_master__*.csv`（最新を利用）

### CSVの特徴
- 冒頭にメタ情報行あり → **「表章項目 コード」行からヘッダ**
- 年ごとに列名が微妙に異なる
  - 2018: `地域 コード`, `地域`
  - 2023: `全国、都道府県、市区町村 コード`, `全国、都道府県、市区町村`

---

## ETL処理フロー

1. **ヘッダ検出**  
   - 「表章項目 コード」が現れる行番号を探し、そこから読み込み開始

2. **列名正規化**  
   - 全角→半角、空白除去  
   - エイリアス対応:  
     - `地域 コード` / `全国、都道府県、市区町村 コード` → `市区町村コード`  
     - `地域` / `全国、都道府県、市区町村` → `市区町村名`

3. **対象レベルの限定**  
   - 全国 (`00000`)、都道府県 (`xx000`)、政令市 (`xxx00`) を除外  
   - → **5桁コード末尾が 000 以外の市区町村のみ**

4. **数値整形**  
   - `総数`, `空き家` 列からカンマを除去  
   - `"-"` を欠損値に変換  
   - float型に変換

5. **市区町村マスタと結合**  
   - キー: `市区町村コード` + `市区町村名`  
   - マスタから以下の情報を付与  
     - 都道府県コード（2桁ゼロ埋め）  
     - 都道府県名  
     - 市区町村ふりがな  
     - 過疎地域市町村フラグ  
     - 都市種別  
     - （必要に応じて政令市・郡名など）

6. **指標計算**  
   - `空き家率 = 空き家 / 総数 * 100`  
   - ワイド化（2018, 2023 列に展開）  
   - 派生指標を追加:  
     - `空き家率_2023`  
     - `空き家_増加率_5年_% = (空き家2023 - 空き家2018) / 空き家2018 * 100`  
     - `空き家率_差分_5年_pt = 空き家率2023 - 空き家率2018`

7. **学習地域のフィルタ（オプション）**  
   - `config/etl_project.yaml` の `study_regions` を参照  
   - `prefecture_codes` または `municipality_codes` で対象を絞る  

---

## 出力
- デフォルト: `data/processed/housing_vacancy__wide__v1_YYYYMMDD.csv`
- 列構成例:

| 市区町村コード | 市区町村名 | 都道府県コード | 都道府県名 | 総数_2018 | 空き家_2018 | 空き家率_2018 | 総数_2023 | 空き家_2023 | 空き家率_2023 | 空き家_増加率_5年_% | 空き家率_差分_5年_pt |
|----------------|------------|----------------|------------|-----------|--------------|---------------|-----------|--------------|---------------|--------------------|---------------------|

---

## 実行コマンド例
```bash
PYTHONPATH=. python scripts/etl/110_estat_housing_vacancy_clean.py \
  --config config/etl_project.yaml \
  --region yatsugatake_alps \
  --out data/processed/housing_vacancy__wide__v1_preview.csv
